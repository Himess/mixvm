#!/bin/bash
# CCTP Attestation Checker & Relayer

MESSAGE_HASH="0x3121e847ed0312c5fe50dfa429aafa26eb2789fb7281c92e61cafd0512c74851"
MESSAGE_BYTES="0x00000001000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008fe6b999dc680ccfdd5bf7eb0974218be2542daa0000000000000000000000008fe6b999dc680ccfdd5bf7eb0974218be2542daa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000036cbd53842c5426634e7929541ec2318f3dcf7e000000000000000000000000394222b73b295374b951b79d5f6796b463392f87000000000000000000000000000000000000000000000000000000000003d090000000000000000000000000df93773761102e0cbc6b90fa04699e7f26ac28c9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

MESSAGE_TRANSMITTER="0xE737e5cEBEEBa77EFE34D4aa090756590b1CE275"
SEPOLIA_RPC="https://ethereum-sepolia-rpc.publicnode.com"
PRIVATE_KEY="0x0beef695a3a30c5eb3a7c3ca656e1d8ec6f9c3a98349959326fe11e4a410dbc6"

echo "=== CCTP Attestation Checker ==="
echo "Message Hash: $MESSAGE_HASH"
echo ""

check_attestation() {
    RESPONSE=$(curl -s "https://iris-api.circle.com/attestations/$MESSAGE_HASH")
    echo "$RESPONSE"
}

echo "Checking attestation..."
RESULT=$(check_attestation)

if echo "$RESULT" | grep -q "error"; then
    echo "Attestation not ready yet."
    echo "Run this script again in a few minutes."
else
    echo "Attestation found!"
    ATTESTATION=$(echo "$RESULT" | grep -o '"attestation":"[^"]*"' | cut -d'"' -f4)

    if [ -n "$ATTESTATION" ]; then
        echo ""
        echo "=== Relaying to Ethereum Sepolia ==="
        cast send $MESSAGE_TRANSMITTER \
            "receiveMessage(bytes,bytes)" \
            $MESSAGE_BYTES \
            $ATTESTATION \
            --rpc-url $SEPOLIA_RPC \
            --private-key $PRIVATE_KEY
    fi
fi
